<script>
    const previewData = {};
    const playbackcapture = document.getElementById('playbackcapture');

    (function localFileVideoPlayer() {
      'use strict'
      var URL = window.URL || window.webkitURL
      var displayMessage = function(message, isError) {
        var element = document.querySelector('#message')
        element.innerHTML = message
        element.className = isError ? 'error' : 'info'
      }
      var playSelectedFile = function(event) {
        var file = this.files[0]
        var type = file.type
        var videoNode = document.querySelector('video')
        var canPlay = videoNode.canPlayType(type)
        if (canPlay === '') canPlay = 'no'
        var message = 'Can play type "' + type + '": ' + canPlay
        var isError = canPlay === 'no'
        displayMessage(message, isError)
    
        if (isError) {
          return
        }
    
        var fileURL = URL.createObjectURL(file)
        videoNode.src = fileURL
        videoNode.focus();
      }
      var inputNode = document.querySelector('input')
      inputNode.addEventListener('change', playSelectedFile, false)
    })()

    const captureButton = document.getElementById('capture');
    const canvas1 = document.getElementById('draw1');
    const canvas2 = document.getElementById('draw2');
    const canvas3 = document.getElementById('draw3');
    const canvasPlayback1 = document.createElement('canvas');
    const canvasPlayback2 = document.createElement('canvas');
    const canvasPlayback3 = document.createElement('canvas');

    const back15s = document.getElementById('back15s');
    const back5s = document.getElementById('back5s');
    const timetext = document.getElementById('timetext');
    const forw5s = document.getElementById('forw5s');
    const forw15s = document.getElementById('forw15s');

    const videoseek = (secs) => {
        if (video.fastSeek) {
            video.fastSeek(video.currentTime + secs)
        } else {
            video.currentTime = video.currentTime + secs
        }            
    }

    // seek curtime
    back15s.addEventListener('click', () => videoseek(-15));
    back5s.addEventListener('click', () => videoseek(-5));

    forw5s.addEventListener('click', () => videoseek(5));
    forw15s.addEventListener('click', () => videoseek(15));


    const playbacks = [];
    playbacks.push({
        small: canvas1,
        isFirst: true,
        big: canvasPlayback1,
        isActive: false,
        videoname: ''
    });
    playbacks.push({
        small: canvas2,
        isFirst: false,
        big: canvasPlayback2,
        isActive: false,
        videoname: ''
    });
    playbacks.push({
        small: canvas3,
        isFirst: false,
        big: canvasPlayback3,
        isActive: false,
        videoname: ''
    });

    const video = document.getElementById('videoele');

    let videoReady = false;


    const copyCanvasDraw = (canSrc, canDest) => {
        canDest.height = canSrc.height;
        canDest.width = canSrc.width;
        canDest.getContext('2d').drawImage(canSrc, 0, 0);
    }

    const copyImageFromVideo = (video, destPlayback) => {
        let smallCanvasW = 300; //canvasの幅
        let smallCanvasH = (smallCanvasW*video.videoHeight)/video.videoWidth; //canvasの高さ

        destPlayback.small.width = smallCanvasW;
        destPlayback.small.height = smallCanvasH;
        destPlayback.small.getContext('2d').drawImage(video, 0, 0, smallCanvasW, smallCanvasH);

        destPlayback.big.width = video.videoWidth;
        destPlayback.big.height = video.videoHeight;
        destPlayback.big.getContext('2d').drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

        destPlayback.isActive = true;
    }


    setInterval(function(){

        if (!videoReady) return;
        if (video.paused) return;

        let curtime = video.currentTime;

        if (!isNaN(curtime)){
            if (curtime >= 3600) {
                timetext.innerText = new Date(curtime * 1000).toISOString().substr(11, 8);
            }
            else {
                timetext.innerText = new Date(curtime * 1000).toISOString().substr(14, 5);
            }
        }
        

        for(let i = 1; i < playbacks.length; i++){
            if (playbacks[i-1].isActive) {
                const {small:s1, big:s2} = playbacks[i-1];
                const {small:d1, big:d2} = playbacks[i];
                copyCanvasDraw(s1, d1);
                copyCanvasDraw(s2, d2);
                playbacks[i].isActive = true;
            }
        }

        copyImageFromVideo(video, playbacks[0]);
    }, 500);

    const showPlayback = (source, video) => {
        let cw = document.documentElement.clientWidth * 0.95;
        let ch = (cw*video.videoHeight)/video.videoWidth;

        let pad = Math.floor((document.documentElement.clientWidth - cw) / 2) ;

        playbackcapture.width = cw
        playbackcapture.height = ch;
        playbackcapture.style.left = pad + "px";
        // playbackcapture.style.top = pad + "px";
        playbackcapture.style.top = video.offsetTop + "px";
        playbackcapture.style.position = "absolute";          
        playbackcapture.style.visibility = "visible";
        playbackcapture.getContext('2d').drawImage(
            source, 0, 0, cw, ch
        );
    }

    video.onloadedmetadata = function(){ //動画が読み込まれてから処理を開始
        video.volume = 0.3;
        captureButton.disabled = false;
        videoReady = true;

        // example
        capture.addEventListener('click',function(){
            video.focus();
            showPlayback(playbacks[0].big, video);
        });

        const displayPlayback = (playbacks, target, video) => {
            video.focus();
            let q = playbacks.find(x => x.small == target);
            if(q && q.isActive) {
                showPlayback(q.big, video);
            }
        };

        [canvas1, canvas2, canvas3].forEach(x => {
            x.addEventListener('click', () => {
                video.pause();
                video.focus();
                displayPlayback(playbacks, x, video);
            });
        })

        playbackcapture.addEventListener('click', function() {
            playbackcapture.style.visibility = 'hidden';
            video.focus();
            video.play();
        })
    }

</script>    